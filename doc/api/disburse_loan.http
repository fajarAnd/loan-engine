# doc/api/disburse_loan.http

###
# *** LOGIN AS FIELD OFFICER FIRST
POST http://localhost:8080/api/v1/auth/login
Content-Type: application/json

{
  "email": "officer@amartha.com",
  "password": "password123",
  "user_type": "employee"
}

> {%
    client.global.set("officer_token", response.body.data.data.access_token);
%}

###

# *** CREATE COMPLETE LOAN FLOW (Prerequisites for disbursement)
# Step 1: Login as borrower
POST http://localhost:8080/api/v1/auth/login
Content-Type: application/json

{
  "email": "siti.peminjam@gmail.com",
  "password": "password123",
  "user_type": "borrower"
}

> {%
    client.global.set("borrower_token", response.body.data.data.access_token);
%}

###

# Step 2: Create loan proposal
POST http://localhost:8080/api/v1/loans
Authorization: Bearer {{borrower_token}}
Content-Type: application/json

{
  "principal_amount": 5000000.00,
  "interest_rate": 10.00,
  "roi_rate": 8.00,
  "loan_term_month": 12
}

> {%
    client.global.set("loan_id", response.body.data.data.id);
%}

###

# Step 3: Login as validator and upload survey
POST http://localhost:8080/api/v1/auth/login
Content-Type: application/json

{
  "email": "validator@amartha.com",
  "password": "password123",
  "user_type": "employee"
}

> {%
    client.global.set("validator_token", response.body.data.data.access_token);
%}

###

# Step 4: Upload survey document
POST http://localhost:8080/api/v1/files/upload
Authorization: Bearer {{validator_token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="loan_id"

{{loan_id}}
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="survey_date"

2025-06-15
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="survey_notes"

Survey completed for disbursement preparation
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="survey_proof.jpg"
Content-Type: image/jpeg

[Binary file content]
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###

# Step 5: Approve loan (PROPOSED → APPROVED)
PUT http://localhost:8080/api/v1/loans/{{loan_id}}/approve
Authorization: Bearer {{officer_token}}
Content-Type: application/json

{
  "approval_notes": "Loan approved and ready for investment before disbursement"
}

###

# Step 6: Login as investors and make investments
POST http://localhost:8080/api/v1/auth/login
Content-Type: application/json

{
  "email": "rina.investor@gmail.com",
  "password": "password123",
  "user_type": "investor"
}

> {%
    client.global.set("investor1_token", response.body.data.data.access_token);
%}

###

# Step 7: First investment (APPROVED → FUNDING)
POST http://localhost:8080/api/v1/loans/{{loan_id}}/investments
Authorization: Bearer {{investor1_token}}
Content-Type: application/json

{
  "investment_amount": 2000000.00
}

###

# Step 8: Login as second investor
POST http://localhost:8080/api/v1/auth/login
Content-Type: application/json

{
  "email": "doni.kapital@gmail.com",
  "password": "password123",
  "user_type": "investor"
}

> {%
    client.global.set("investor2_token", response.body.data.data.access_token);
%}

###

# Step 9: Complete investment (FUNDING → INVESTED)
POST http://localhost:8080/api/v1/loans/{{loan_id}}/investments
Authorization: Bearer {{investor2_token}}
Content-Type: application/json

{
  "investment_amount": 3000000.00
}

###

# *** DISBURSE LOAN - SUCCESS (INVESTED → DISBURSED)
PUT http://localhost:8080/api/v1/loans/{{loan_id}}/disburse
Authorization: Bearer {{officer_token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="disbursement_notes"

Loan successfully disbursed to borrower. All documents verified and money transferred.
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="signed_agreement"; filename="signed_agreement.pdf"
Content-Type: application/pdf

[Binary PDF content - signed loan agreement]
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###

# *** ERROR CASES ***

# *** DISBURSE LOAN - Missing File (400 Bad Request)
PUT http://localhost:8080/api/v1/loans/{{loan_id}}/disburse
Authorization: Bearer {{officer_token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="disbursement_notes"

Missing signed agreement file
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###

# *** DISBURSE LOAN - Invalid File Type (400 Bad Request)
PUT http://localhost:8080/api/v1/loans/{{loan_id}}/disburse
Authorization: Bearer {{officer_token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="disbursement_notes"

Invalid file type test
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="signed_agreement"; filename="agreement.txt"
Content-Type: text/plain

This is not a valid file type
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###

# *** DISBURSE LOAN - Invalid Loan ID (400 Bad Request)
PUT http://localhost:8080/api/v1/loans/invalid-uuid/disburse
Authorization: Bearer {{officer_token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="signed_agreement"; filename="signed_agreement.pdf"
Content-Type: application/pdf

[Binary PDF content]
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###

# *** DISBURSE LOAN - Non-existent Loan (404 Not Found)
PUT http://localhost:8080/api/v1/loans/123e4567-e89b-12d3-a456-426614174999/disburse
Authorization: Bearer {{officer_token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="signed_agreement"; filename="signed_agreement.pdf"
Content-Type: application/pdf

[Binary PDF content]
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###

# *** DISBURSE LOAN - Wrong User Type (403 Forbidden)
PUT http://localhost:8080/api/v1/loans/{{loan_id}}/disburse
Authorization: Bearer {{borrower_token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="signed_agreement"; filename="signed_agreement.pdf"
Content-Type: application/pdf

[Binary PDF content]
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###

# *** DISBURSE LOAN - Wrong Role (403 Forbidden)
PUT http://localhost:8080/api/v1/loans/{{loan_id}}/disburse
Authorization: Bearer {{validator_token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="signed_agreement"; filename="signed_agreement.pdf"
Content-Type: application/pdf

[Binary PDF content]
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###

# *** DISBURSE LOAN - No Authentication (401 Unauthorized)
PUT http://localhost:8080/api/v1/loans/{{loan_id}}/disburse
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="signed_agreement"; filename="signed_agreement.pdf"
Content-Type: application/pdf

[Binary PDF content]
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###

# *** DISBURSE LOAN - Invalid Token (401 Unauthorized)
PUT http://localhost:8080/api/v1/loans/{{loan_id}}/disburse
Authorization: Bearer invalid-token-here
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="signed_agreement"; filename="signed_agreement.pdf"
Content-Type: application/pdf

[Binary PDF content]
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###

# *** DISBURSE LOAN - Already Disbursed (409 Conflict)
# Try to disburse the same loan again
PUT http://localhost:8080/api/v1/loans/{{loan_id}}/disburse
Authorization: Bearer {{officer_token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="disbursement_notes"

Second disbursement attempt (should fail)
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="signed_agreement"; filename="signed_agreement_2.pdf"
Content-Type: application/pdf

[Binary PDF content]
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###

# *** TEST DIFFERENT FILE TYPES ***

# *** DISBURSE LOAN - JPEG File (Should Success)
PUT http://localhost:8080/api/v1/loans/{{loan_id}}/disburse
Authorization: Bearer {{officer_token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="disbursement_notes"

Using JPEG signed agreement
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="signed_agreement"; filename="signed_agreement.jpg"
Content-Type: image/jpeg

[Binary JPEG content]
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###

# *** VIEW UPLOADED SIGNED AGREEMENT
GET http://localhost:8080/uploads/agreements/signed_agreement_{{loan_id}}.pdf

###

# *** LARGE FILE TEST (> 10MB) - Should fail
PUT http://localhost:8080/api/v1/loans/{{loan_id}}/disburse
Authorization: Bearer {{officer_token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="disbursement_notes"

Large file test
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="signed_agreement"; filename="large_agreement.pdf"
Content-Type: application/pdf

[Large binary content > 10MB - simulate by repeating content]
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###

# *** STRESS TEST - Multiple Rapid Requests
PUT http://localhost:8080/api/v1/loans/{{loan_id}}/disburse
Authorization: Bearer {{officer_token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="disbursement_notes"

Rapid request test 1
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="signed_agreement"; filename="rapid_1.pdf"
Content-Type: application/pdf

[Binary PDF content]
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###

PUT http://localhost:8080/api/v1/loans/{{loan_id}}/disburse
Authorization: Bearer {{officer_token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="disbursement_notes"

Rapid request test 2
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="signed_agreement"; filename="rapid_2.pdf"
Content-Type: application/pdf

[Binary PDF content]
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###